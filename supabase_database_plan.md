## تخطيط قاعدة البيانات (Supabase) لتطبيق حاسبتي

بناءً على المتطلبات المفصلة لتطبيق "حاسبتي"، سنقوم بتصميم قاعدة بيانات PostgreSQL في Supabase لدعم جميع الميزات وأنواع المستخدمين. الهدف هو إنشاء هيكل مرن وقابل للتوسع.

### 1. جدول المستخدمين (users)

سيتم إدارة هذا الجدول بشكل أساسي بواسطة Supabase Auth، ولكن يمكننا إضافة أعمدة إضافية لتخزين معلومات الملف الشخصي الخاصة بالمستخدمين.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف المستخدم الفريد (من Supabase Auth)    | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `email`      | `text`     | البريد الإلكتروني للمستخدم                 |                                               |
| `user_type`  | `text`     | نوع المستخدم (normal_user, business_owner, professional_accountant) | لتحديد واجهة المستخدم والميزات المتاحة      |
| `created_at` | `timestampz` | تاريخ ووقت إنشاء الحساب                   | يتم إنشاؤه تلقائيًا                          |

### 2. جدول العمليات المالية (transactions)

لتسجيل الإيرادات والمصروفات.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف العملية الفريد                        | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم الذي قام بالعملية           | مفتاح خارجي يربط بجدول `users`                 |
| `type`       | `text`     | نوع العملية (income, expense)             |                                               |
| `name`       | `text`     | اسم العملية (مثال: بيع منتج، إيجار)        |                                               |
| `amount`     | `numeric`  | المبلغ المالي للعملية                     |                                               |
| `category`   | `text`     | تصنيف العملية (مثال: طعام، مواصلات، مبيعات) | يمكن أن يكون مقترحًا بواسطة الذكاء الاصطناعي |
| `date`       | `date`     | تاريخ العملية                             |                                               |
| `notes`      | `text`     | ملاحظات إضافية                             | اختياري                                      |
| `created_at` | `timestampz` | تاريخ ووقت إنشاء السجل                     | يتم إنشاؤه تلقائيًا                          |

### 3. جدول العملاء (customers)

لتسجيل معلومات العملاء لأصحاب الأعمال والمحاسبين.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف العميل الفريد                         | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم الذي أضاف العميل            | مفتاح خارجي يربط بجدول `users`                 |
| `name`       | `text`     | اسم العميل                                |                                               |
| `phone`      | `text`     | رقم هاتف العميل                            | اختياري                                      |
| `email`      | `text`     | البريد الإلكتروني للعميل                   | اختياري                                      |
| `created_at` | `timestampz` | تاريخ ووقت إنشاء السجل                     | يتم إنشاؤه تلقائيًا                          |

### 4. جدول الفواتير (invoices)

لتسجيل فواتير البيع والشراء.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف الفاتورة الفريد                       | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم الذي أنشأ الفاتورة          | مفتاح خارجي يربط بجدول `users`                 |
| `customer_id`| `uuid`     | معرف العميل المرتبط بالفاتورة             | مفتاح خارجي يربط بجدول `customers` (اختياري) |
| `type`       | `text`     | نوع الفاتورة (sale, purchase)             |                                               |
| `invoice_date`| `date`     | تاريخ الفاتورة                            |                                               |
| `total_amount`| `numeric`  | إجمالي مبلغ الفاتورة                      |                                               |
| `discount`   | `numeric`  | الخصم المطبق                              | اختياري                                      |
| `tax`        | `numeric`  | الضريبة المطبقة                           | اختياري                                      |
| `status`     | `text`     | حالة الفاتورة (paid, pending, overdue)   |                                               |
| `notes`      | `text`     | ملاحظات إضافية                             | اختياري                                      |
| `created_at` | `timestampz` | تاريخ ووقت إنشاء السجل                     | يتم إنشاؤه تلقائيًا                          |

### 5. جدول بنود الفاتورة (invoice_items)

لتفاصيل الأصناف داخل كل فاتورة.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف البند الفريد                          | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `invoice_id` | `uuid`     | معرف الفاتورة المرتبطة                     | مفتاح خارجي يربط بجدول `invoices`              |
| `item_name`  | `text`     | اسم الصنف                                 |                                               |
| `quantity`   | `numeric`  | الكمية                                     |                                               |
| `unit_price` | `numeric`  | سعر الوحدة                                |                                               |
| `total_price`| `numeric`  | السعر الإجمالي للبند                      | `quantity * unit_price`                       |

### 6. جدول تصنيفات الذكاء الاصطناعي (ai_categories)

لتخزين التصنيفات المقترحة بواسطة الذكاء الاصطناعي وتفضيلات المستخدم.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف التصنيف الفريد                        | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم                              | مفتاح خارجي يربط بجدول `users`                 |
| `category_name`| `text`     | اسم التصنيف                               |                                               |
| `is_suggested`| `boolean`  | هل تم اقتراحه بواسطة الذكاء الاصطناعي؟    |                                               |
| `is_user_defined`| `boolean`  | هل تم تعريفه بواسطة المستخدم؟             |                                               |

### 7. جدول الإعدادات (settings)

لتخزين إعدادات المستخدم الخاصة.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف الإعداد الفريد                        | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم                              | مفتاح خارجي يربط بجدول `users`                 |
| `setting_key`| `text`     | مفتاح الإعداد (مثال: language, business_type) |                                               |
| `setting_value`| `text`     | قيمة الإعداد                               |                                               |

### العلاقات (Relationships)

*   `users` 1-to-many `transactions` (user_id)
*   `users` 1-to-many `customers` (user_id)
*   `users` 1-to-many `invoices` (user_id)
*   `users` 1-to-many `ai_categories` (user_id)
*   `users` 1-to-many `settings` (user_id)
*   `customers` 1-to-many `invoices` (customer_id) - اختياري
*   `invoices` 1-to-many `invoice_items` (invoice_id)

### سياسات الأمان (Row Level Security - RLS)

سيتم تطبيق RLS لضمان أن كل مستخدم يمكنه فقط الوصول إلى بياناته الخاصة. على سبيل المثال:

*   يمكن للمستخدمين إدراج، قراءة، تحديث، وحذف السجلات في `transactions`، `customers`، `invoices`، `ai_categories`، `settings` حيث يكون `user_id` مساويًا لـ `auth.uid()`.

هذا التخطيط يوفر أساسًا قويًا لتطبيق "حاسبتي" في Supabase. سننتقل الآن إلى إعداد بيئة Supabase والربط مع تطبيق Flutter.



### 8. جدول المنتجات (products)

لتسجيل تفاصيل المنتجات التي يتم بيعها أو شراؤها.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف المنتج الفريد                         | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم الذي أضاف المنتج            | مفتاح خارجي يربط بجدول `users`                 |
| `name`       | `text`     | اسم المنتج                                |                                               |
| `description`| `text`     | وصف المنتج                                | اختياري                                      |
| `barcode`    | `text`     | رمز الباركود للمنتج                        | فريد، يمكن استخدامه للبحث السريع             |
| `unit`       | `text`     | وحدة القياس (مثال: قطعة، كجم، لتر)        |                                               |
| `purchase_price`| `numeric`  | سعر الشراء الافتراضي للمنتج               |                                               |
| `sale_price` | `numeric`  | سعر البيع الافتراضي للمنتج                 |                                               |
| `current_stock`| `numeric`  | الكمية الحالية في المخزون                  | يتم تحديثه تلقائيًا                          |
| `min_stock_level`| `numeric`  | الحد الأدنى للمخزون لإصدار تنبيه          |                                               |
| `category`   | `text`     | تصنيف المنتج (مثال: ألبان، منظفات، أدوية) |                                               |
| `expiry_date_required`| `boolean`  | هل يتطلب المنتج تاريخ انتهاء صلاحية؟      | مهم للصيدليات والسوبر ماركت                  |
| `created_at` | `timestampz` | تاريخ ووقت إنشاء السجل                     | يتم إنشاؤه تلقائيًا                          |

### 9. جدول الموردين (suppliers)

لتسجيل معلومات الموردين.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف المورد الفريد                         | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم الذي أضاف المورد            | مفتاح خارجي يربط بجدول `users`                 |
| `name`       | `text`     | اسم المورد                                |                                               |
| `contact_person`| `text`     | اسم شخص الاتصال                           | اختياري                                      |
| `phone`      | `text`     | رقم هاتف المورد                            | اختياري                                      |
| `email`      | `text`     | البريد الإلكتروني للمورد                   | اختياري                                      |
| `address`    | `text`     | عنوان المورد                               | اختياري                                      |
| `created_at` | `timestampz` | تاريخ ووقت إنشاء السجل                     | يتم إنشاؤه تلقائيًا                          |

### 10. جدول المشتريات (purchases)

لتسجيل أوامر الشراء واستلام البضاعة.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف الشراء الفريد                         | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم الذي قام بالشراء            | مفتاح خارجي يربط بجدول `users`                 |
| `supplier_id`| `uuid`     | معرف المورد                                | مفتاح خارجي يربط بجدول `suppliers`             |
| `purchase_date`| `date`     | تاريخ الشراء                              |                                               |
| `total_amount`| `numeric`  | إجمالي مبلغ الشراء                        |                                               |
| `status`     | `text`     | حالة الشراء (pending, completed, cancelled)|                                               |
| `notes`      | `text`     | ملاحظات إضافية                             | اختياري                                      |
| `created_at` | `timestampz` | تاريخ ووقت إنشاء السجل                     | يتم إنشاؤه تلقائيًا                          |

### 11. جدول بنود المشتريات (purchase_items)

لتفاصيل الأصناف داخل كل عملية شراء.

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف البند الفريد                          | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `purchase_id`| `uuid`     | معرف الشراء المرتبط                        | مفتاح خارجي يربط بجدول `purchases`             |
| `product_id` | `uuid`     | معرف المنتج                                | مفتاح خارجي يربط بجدول `products`              |
| `quantity`   | `numeric`  | الكمية المشتراة                            |                                               |
| `unit_price` | `numeric`  | سعر الوحدة عند الشراء                     |                                               |
| `total_price`| `numeric`  | السعر الإجمالي للبند                      | `quantity * unit_price`                       |
| `expiry_date`| `date`     | تاريخ انتهاء الصلاحية (إن وجد)            | مهم للمنتجات التي تتطلب ذلك                  |

### 12. جدول حركات المخزون (stock_movements)

لتتبع جميع التغييرات في المخزون (إضافة، خصم، تعديل).

| العمود       | النوع       | الوصف                                      | ملاحظات                                      |
|--------------|------------|--------------------------------------------|-----------------------------------------------|
| `id`         | `uuid`     | معرف الحركة الفريد                         | مفتاح أساسي، يتم إنشاؤه تلقائيًا              |
| `user_id`    | `uuid`     | معرف المستخدم الذي قام بالحركة            | مفتاح خارجي يربط بجدول `users`                 |
| `product_id` | `uuid`     | معرف المنتج                                | مفتاح خارجي يربط بجدول `products`              |
| `movement_type`| `text`     | نوع الحركة (in, out, adjustment)          |                                               |
| `quantity_change`| `numeric`  | التغير في الكمية (موجب للإضافة، سالب للخصم)|                                               |
| `reason`     | `text`     | سبب الحركة (مثال: بيع، شراء، تلف، جرد)    |                                               |
| `related_id` | `uuid`     | معرف السجل المرتبط (فاتورة، شراء)         | اختياري، يربط بـ `invoices` أو `purchases`    |
| `created_at` | `timestampz` | تاريخ ووقت الحركة                          | يتم إنشاؤه تلقائيًا                          |

### تحديث العلاقات (Relationships)

*   `users` 1-to-many `products` (user_id)
*   `users` 1-to-many `suppliers` (user_id)
*   `users` 1-to-many `purchases` (user_id)
*   `users` 1-to-many `stock_movements` (user_id)
*   `suppliers` 1-to-many `purchases` (supplier_id)
*   `purchases` 1-to-many `purchase_items` (purchase_id)
*   `products` 1-to-many `purchase_items` (product_id)
*   `products` 1-to-many `stock_movements` (product_id)
*   `invoices` 1-to-many `stock_movements` (related_id - عندما تكون الحركة بيع)
*   `purchases` 1-to-many `stock_movements` (related_id - عندما تكون الحركة شراء)

### تحديث سياسات الأمان (Row Level Security - RLS)

سيتم توسيع RLS ليشمل الجداول الجديدة، لضمان أن كل مستخدم يمكنه فقط الوصول إلى بياناته الخاصة في `products`، `suppliers`، `purchases`، `purchase_items`، و `stock_movements` حيث يكون `user_id` مساويًا لـ `auth.uid()`.

هذا التحديث لتخطيط قاعدة البيانات يوفر الأساس اللازم لدمج ميزات إدارة المخزون الشاملة في تطبيق "حاسبتي".

